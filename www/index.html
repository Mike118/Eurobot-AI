<html>
    <head>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js" type="text/javascript"></script>
        <script src="https://unpkg.com/vue"></script>
    </head>
    <body>

        <h1>Hello world -</h1>
        <button onclick="sendStart()">Start AI</button>

        <div id="app">
            {{ message }}
            <svg width="500" height="400" viewBox="-100 -100 3200 2200" unit="mm">
                <template v-if="map.background != ''">
                    <image v-bind:href="map.background" x="0" y="0" height="2000" width="3000" /> 
                </template>
                <template v-for="item in map.components">
                    <template v-if="item.shape.type == 'rectangle'">
                        <g>
                            <title>{{item.name}} - {{item.type}} - {{item.team}}</title>
                            <rect v-bind:x="item.shape.x" v-bind:y="item.shape.y" v-bind:width="item.shape.width" v-bind:height="item.shape.height" v-bind:style="{ fill: item.shape.color }" style="stroke-width:1;stroke:rgb(0,0,0);opacity: 0.9;" />
                        </g>
                    </template>
                    <template v-if="item.shape.type == 'circle'">
                        <g>
                            <title>{{item.name}} - {{item.type}} - {{item.team}}</title>
                            <circle  v-bind:cx="item.shape.x" v-bind:cy="item.shape.y" v-bind:r="item.shape.radius" v-bind:title="item.shape.name" v-bind:style="{ fill: item.shape.color }" style="stroke-width:1;stroke:rgb(0,0,0);opacity: 0.9;" />
                        </g>
                    </template>
                </template>
            </svg>
        </div>

        <script>
            var map = {
                width: 0,
                height: 0,
                background: "",
                components: []
            };

            // connect the client
            var client = new Paho.MQTT.Client(location.hostname, 8081, "webClient-"+(new Date().getTime()));
            client.connect({onSuccess:onConnect});

            // called when the client connects
            function onConnect() {
                // Once a connection has been made, make a subscription and send a message.
                console.log("onConnect");
                client.subscribe("/logs");
                client.subscribe("/map");
                /*message = new Paho.MQTT.Message("WebClient connected");
                message.destinationName = "/logs";
                client.send(message);*/
            }

            // called when the client loses its connection
            client.onConnectionLost = function onConnectionLost(responseObject) {
                if (responseObject.errorCode !== 0) {
                    console.log("onConnectionLost:"+responseObject.errorMessage);
                }
            }

            // called when a message arrives
            client.onMessageArrived = function onMessageArrived(message) {
                if(message.destinationName == "/map"){
                    var newMap = JSON.parse(message.payloadString)
                    Object.assign(map, newMap);
                    console.log(map)
                }
                else
                    console.log("onMessageArrived:"+message.payloadString);
            }

            function sendStart(){
                var payload = {action: "run"};
                var message = new Paho.MQTT.Message(JSON.stringify(payload));
                message.destinationName = "/control";
                client.send(message);
            }

            Vue.component("tableMap", {
                props: { components: Array },
                template: "#tableMap-template",
            });

            /*new Vue({
                el: "#vueJSRenderer",
                data: {
                components: map.components
                },
                methods: { }
            });*/
            var app = new Vue({
                el: '#app',
                data: {
                    message: 'Hello Vue!',
                    map: map
                }
            })
        </script>
    </body>

</html>